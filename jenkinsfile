pipeline{
    agent none
    environnement{
        DOCKERHUB_CREDENTIALS = credentials('db_cred')


    }
    trigger{
        pollSCM {'*/5 * * * *'}

    }
    stages{
        stage ('checkout'){
            agent any
            steps{
                checkout scm

            }
        }
        stage('Init'){
            agent any 
            steps{
                sh 'echo $DOCKERHUB_CREDENTIALS_PSW |docker login -u DOCKERHUB_CREDENTIALS_USR --password-stdin'

            }
            
        }
        stage('Build Backend'){

            agent any 
            when{
                changements "**/backend/*.*"
                beforeAgent true

            }
            steps{
                dir('backend'){
                    sh 'docker build -t $DOCKERHUB_CREDENTIALS_USR/ecommmerce_backend:$BUILD_ID .'
                    sh 'docker push docker build -t $DOCKERHUB_CREDENTIALS_USR/ecommmerce_backend:$BUILD_ID'
                    sh 'docker push docker rmi -t $DOCKERHUB_CREDENTIALS_USR/ecommmerce_backend:$BUILD_ID'
                }
            }
        }
        stage('Build frontend'){

            agent any 
            when{
                changements "**/frontend/*.*"
                beforeAgent true

            }
            steps{
                dir('backend'){
                    sh 'docker build -t $DOCKERHUB_CREDENTIALS_USR/ecommmerce_frontend:$BUILD_ID .'
                    sh 'docker push docker build -t $DOCKERHUB_CREDENTIALS_USR/ecommmerce_frontend:$BUILD_ID'
                    sh 'docker push docker rmi -t $DOCKERHUB_CREDENTIALS_USR/ecommmerce_frontend:$BUILD_ID'
                }
            }
        }
    }
}
